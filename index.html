<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>خريطة الزراعات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Locate Control -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css" />
  <script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      direction: rtl;
      font-family: sans-serif;
    }

    #searchBox {
      width: 100%;
      background: white;
      padding: 10px;
      display: flex;
      gap: 10px;
      border-bottom: 1px solid #ccc;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 1000;
      box-sizing: border-box;
    }

    #searchBox select, #searchBox input {
      padding: 5px;
      flex: 1;
    }

    #layout {
      display: flex;
      height: calc(100% - 60px); /* subtract height of searchBox */
    }

    #chartBox, #chartBoxLive {
      width: 250px;
      min-width: 200px;
      max-width: 300px;
      height: 100%;
      padding: 10px;
      box-sizing: border-box;
      background: white;
      border-left: 1px solid #ddd;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      justify-content: start;
      align-items: center;
      overflow-y: auto;
    }

    #chartBoxLive {
      border-right: none;
    }

    #chartBox canvas,
    #chartBoxLive canvas {
      width: 100% !important;
      height: auto !important;
      max-height: 250px;
    }

    .chart-title {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 16px;
      color: darkgreen;
    }

    #map {
      flex: 1;
      height: 100%;
    }

    .leaflet-tooltip.custom-card {
      background: white !important;
      border-radius: 8px !important;
      padding: 6px 8px !important;
      border: 1px solid #ccc !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      color: #333;
      font-size: 12px;
    }

    .leaflet-popup-content-wrapper {
      background: transparent;
      box-shadow: none;
      border: none;
    }

    .custom-popup {
      background: white;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
      position: relative;
      animation: floatIn 0.4s ease-out;
    }

    .popup-arrow {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-top: 10px solid white;
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
    }

    @keyframes floatIn {
      from { transform: scale(0.8) translateY(10px); opacity: 0; }
      to   { transform: scale(1) translateY(0); opacity: 1; }
    }

    @media (max-width: 768px) {
      #layout {
        flex-direction: column;
      }

      #chartBox, #chartBoxLive {
        width: 100%;
        height: auto;
        max-height: 300px;
        border: none;
        border-top: 1px solid #ddd;
      }

      #map {
        height: 400px;
      }
    }
  </style>
</head>
<body>

  <div id="searchBox">
    <select id="fieldSelector">
      <option value="Name_Tenanet">اسم المستأجر</option>
      <option value="NUM_Place">رقم القطعة</option>
      <option value="Contract_Area">مساحة العقد</option>
      <option value="Surveying_Area">مساحة الرفع</option>
    </select>
    <input type="text" id="searchInput" placeholder="اكتب للبحث..." />
  </div>

  <div id="layout">
    <div id="chartBox">
      <div class="chart-title">بيان زراعات الدلتا</div>
      <canvas id="pieChart"></canvas>
    </div>
    <div id="map"></div>
    <div id="chartBoxLive">
      <div class="chart-title">المؤشرات الظاهرة</div>
      <canvas id="pieChartLive"></canvas>
    </div>
  </div>

  <script>
    var map = L.map('map').setView([31.05, 31.49], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.de/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    let agricultureLayer;
    let pieChart, pieLiveChart;

    fetch('agriculture3.geojson')
      .then(res => res.json())
      .then(data => {
        agricultureLayer = L.geoJSON(data, {
          onEachFeature: function (feature, layer) {
            const p = feature.properties;
            const html = `
              <div><b>المستأجر:</b> ${p.Name_Tenanet || 'غير معروف'}</div>
              <div><b>القطعة:</b> ${p.NUM_Place || '-'}</div>
              <div><b>العقد:</b> ${p.Contract_Area || '-'} ف</div>
              <div><b>الرفع:</b> ${p.Surveying_Area ? parseFloat(p.Surveying_Area).toFixed(2) : '-'} ف</div>
            `;
            layer.bindTooltip(html, {
              permanent: true,
              direction: 'top',
              className: 'custom-card',
              opacity: 0.95
            });

            layer.bindPopup(`
              <div class="custom-popup">
                <div class="popup-content">${html}</div>
                <div class="popup-arrow"></div>
              </div>
            `);
          },
          style: { color: 'red', weight: 2 }
        }).addTo(map);

        map.fitBounds(agricultureLayer.getBounds());

        const tenants = new Set();
        let totalContract = 0, totalSurvey = 0;
        data.features.forEach(f => {
          const p = f.properties;
          if (p.Name_Tenanet) tenants.add(p.Name_Tenanet.trim());
          if (!isNaN(+p.Contract_Area)) totalContract += +p.Contract_Area;
          if (!isNaN(+p.Surveying_Area)) totalSurvey += +p.Surveying_Area;
        });

        pieChart = new Chart(document.getElementById('pieChart'), {
          type: 'pie',
          data: {
            labels: ['المستأجرين', 'عدد القطع', 'العقود (ف)', 'الرفع (ف)'],
            datasets: [{
              data: [tenants.size, data.features.length, totalContract.toFixed(2), totalSurvey.toFixed(2)],
              backgroundColor: ['#4caf50', '#2196f3', '#ff9800', '#e91e63'],
              borderColor: '#fff',
              borderWidth: 2
            }]
          },
          options: { responsive: true, maintainAspectRatio: false }
        });

        function updateLiveChart() {
          const bounds = map.getBounds();
          let visibleTenants = new Set();
          let count = 0, contract = 0, survey = 0;

          agricultureLayer.eachLayer(layer => {
            if (bounds.intersects(layer.getBounds())) {
              const p = layer.feature.properties;
              count++;
              if (p.Name_Tenanet) visibleTenants.add(p.Name_Tenanet.trim());
              if (!isNaN(+p.Contract_Area)) contract += +p.Contract_Area;
              if (!isNaN(+p.Surveying_Area)) survey += +p.Surveying_Area;
            }
          });

          const newData = [visibleTenants.size, count, contract.toFixed(2), survey.toFixed(2)];

          if (pieLiveChart) {
            pieLiveChart.data.datasets[0].data = newData;
            pieLiveChart.update();
          } else {
            pieLiveChart = new Chart(document.getElementById('pieChartLive'), {
              type: 'pie',
              data: {
                labels: ['المستأجرين', 'عدد القطع', 'العقود (ف)', 'الرفع (ف)'],
                datasets: [{
                  data: newData,
                  backgroundColor: ['#2ecc71', '#3498db', '#f1c40f', '#e74c3c'],
                  borderColor: '#fff',
                  borderWidth: 2
                }]
              },
              options: { responsive: true, maintainAspectRatio: false }
            });
          }
        }

        updateLiveChart();
        map.on('moveend', updateLiveChart);

        map.on('zoomend', () => {
          const z = map.getZoom();
          agricultureLayer.eachLayer(l => {
            if (z >= 15) l.openTooltip(); else l.closeTooltip();
          });
        });

        document.getElementById('searchInput').addEventListener('input', applySearch);
        document.getElementById('fieldSelector').addEventListener('change', applySearch);

        function applySearch() {
          const field = document.getElementById('fieldSelector').value;
          const q = document.getElementById('searchInput').value.trim().toLowerCase();
          const hits = [];

          agricultureLayer.eachLayer(layer => {
            const val = (layer.feature.properties[field] + '').toLowerCase();
            if (val.includes(q)) {
              layer.setStyle({ color: 'blue', weight: 4 });
              hits.push(layer);
            } else {
              layer.setStyle({ color: 'gray', weight: 1 });
            }
          });

          if (hits.length > 0) map.fitBounds(new L.featureGroup(hits).getBounds());
        }
      });

    L.control.locate({ position: 'topright', strings: { title: "اظهار موقعي" } }).addTo(map);

    const zoomHome = L.control({ position: 'topright' });
    zoomHome.onAdd = () => {
      const div = L.DomUtil.create('div', 'leaflet-control-zoom-home');
      div.innerHTML = '↺';
      div.title = 'عرض كل الزراعات';
      div.style.cursor = 'pointer';
      div.style.background = 'white';
      div.style.padding = '5px';
      div.onclick = () => map.fitBounds(agricultureLayer.getBounds());
      return div;
    };
    zoomHome.addTo(map);
  </script>
</body>
</html>
